# Работа с базами данных, пользователями и правами

## Цели:
1. Создание новой базы данных, схемы и таблицы.
1. Создание роли для чтения данных из созданной схемы созданной базы данных.
1. Создание роли для чтения и записи из созданной схемы созданной базы данных.

## Описание выполнения домашнего задания

### Шаг 1. Создать новый кластер PostgreSQL, подготовить базу данных и схему данных.

> В качестве платформы с облачными сервисами будем использовать Yandex Cloud. Подготовим инстанс по уже известным шагам. Опишем команды для установки PostgreSQL 14 и выполнения необходимых действий.

**Результат**

Создана виртуальная машина (**gchibizov-pg-20220807**):
![Виртуальная машина](/images/scr-dz07-01.png)

Команда для установки PostgreSQL:

```
sudo apt update && sudo apt upgrade -y && sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list' && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - && sudo apt-get update && sudo apt-get -y install postgresql-14
```

Подготовим базу данных, схему. Будем использовать следующие запросы и команды:

```sql
sudo -u postgres psql

CREATE DATABASE testdb;
CREATE SCHEMA testnm;

SELECT oid, datname, datistemplate, datallowconn FROM pg_database;
SELECT current_schema();
SELECT * FROM pg_namespace;

SHOW search_path;
```
![Подготовим БД и схему данных](/images/scr-dz07-02.png)


### Шаг 2. Создать роль readonly, пользователя testread. Привязать роль к БД testdb и поиграть с доступом к таблицам.

> В качестве вспомогтаельного материала можно использовать список команд из занятия + документаця Postgre (неоходимо уметь работать с документацией). На крайний случай подготовлена шпаргалка, в нее можно заглянуть после выполнения задания.

**Результат**

Подготоим роль **readonly** и пользователя **testread**:

```sql
-- создайте новую роль readonly
CREATE ROLE readonly;

-- дайте новой роли право на подключение к базе данных testdb
GRANT CONNECT ON DATABASE testdb TO readonly;

-- дайте новой роли право на использование схемы testnm
GRANT USAGE ON SCHEMA testnm TO readonly;

-- дайте новой роли право на select для всех таблиц схемы testnm
GRANT SELECT ON ALL TABLES IN SCHEMA testnm TO readonly;

-- создайте пользователя testread с паролем test123
CREATE USER testread PASSWORD 'test123';

-- дайте роль readonly пользователю testread
GRANT readonly TO testread;

-- для таблицы
create table t1 (c1 integer);
insert into t1 values (1);
select * from t1;

# Не забываем про команду подключения к БД через нового пользователя (без создания пользователя в UNIX-системе)
sudo -u postgres psql -U testread -h 127.0.0.1 -W -d postgres
# Проверить под каким пользователем подключены
\echo :USER

-- посмотреть, а в какой схеме то создалась табличка
select * from pg_catalog.pg_tables pt where tablename = 't1'

-- посмотреть все таблички в схеме из консоли
\dt public.*
```
![Подготовим роль readonly и пользователя testread](/images/scr-dz07-03.png)

Создадим табличку стандартным способом и подключимся к БД через нового пользователя, проверим доступ к табличке:
![Проверка доступов testread](/images/scr-dz07-04.png)

Как видно на скриншоте, доступа к табличке нет. Причину разобрали на занятии, наша табличка стандартным кодом была создана в схеме **public**, а разрешения для работы с объектами выдавали на схему **testnm**. Необходимо при создании таблички явно указывать логическую схему, в которой мы ее хотим разместить.


### Шаг 3. Пробуем создать иначе табличку, проверим доступы.

> Ориентируемся на рекомендации в задании, при создании таблички указываем схему. Внимательно относиться к тому, когда, как и на какие моменты мы выдаем права.

**Результат**

Выполним команды для создания таблчки в схеме **testnm** под пользователем **postgres**:
```sql
-- Создадим табличку
create table testnm.t1 (c1 integer);
insert into testnm.t1 values (1);
select * from testnm.t1;

-- посмотреть, а в какой схеме то создалась табличка
select * from pg_catalog.pg_tables pt where tablename = 't1'
```
![Проверка доступов testread после пересоздания таблички](/images/scr-dz07-05.png)

Прав на доступ снова нет. **Причина:** ранее командами выдали права на уже существующие таблички, поэтому на новую таблицу права не были выданы. Необходимо для исключения подобных проблем выдать права по умолчанию для нашей схемы. **Внимательно относиться к тому, когда, как и на какие моменты мы выдаем права**:
```sql
-- Выдача доступов по умолчанию для схемы и роли
ALTER DEFAULT PRIVILEGES IN SCHEMA testnm grant SELECT ON TABLES TO readonly;
```
![Проверка доступов testread после раздачи прав по умолчанию](/images/scr-dz07-06.png)

Снова получаем ошибку. **Причина:** после настройки раздачи прав по умолчанию, объект остался на своем месте без изменения прав доступа. Необходимо пересоздать объект.
![Итоги после исправления проблем](/images/scr-dz07-07.png)


### Шаг 4. Пробуем теперь под пользователем testread создать табличку и добавить туда данные

> Развиваем дальше тему с доступами к объектам для новых пользователей. Максимально тщательно пытаемся обнаружить дырки в доступах.

**Результат**

Проверим, а что еще может сделать наш новый пользователь:

```sql
-- Создадим табличку
create table t2 (c1 integer);
insert into t2 values (2);
select * from t2;

-- посмотреть, а в какой схеме то создалась табличка
select * from pg_catalog.pg_tables pt where tablename = 't2'
```
![Никаких проблем при создании таблички не было](/images/scr-dz07-08.png)

Новый объект был создан в схеме **public**. А для всех новых пользователей доступ к общей схеме не ограничивается. Возникает вопрос, а как тогда обезопасить наши БД от такого поведения? За командами отправимся в шпаргалку. Сначала забираем права на создание объектов для всех пользователей в общей схеме, потом запрещаем доступ к нашей новой БД для пользователей из общей группы, при этом права для нашей особой группы **readonly** останутсы не тронутыми:
```sql
-- команды из шпаргалки для исключения возможности создания объектов для схемы public
REVOKE CREATE ON SCHEMA public FROM public;
REVOKE ALL ON DATABASE testdb FROM public;
```
![Убираем доступы для public и проверяем](/images/scr-dz07-09.png)

Как видим на скриншоте, доступ закрыт. Нет разрешения для создания таблички в общей схеме, при этом, если попробовать добавить таблчику в схеме **testnm**, прав на это действие так же не будет. Вспомним, какие разрешения были выданы для роли **readonly** - только ЧТЕНИЕ.